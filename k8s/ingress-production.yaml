# Production Ingress for Weather Agent Application
# Provides HTTPS access with automatic SSL certificate management
#
# BEFORE DEPLOYING:
# 1. Install NGINX Ingress Controller
# 2. Install cert-manager
# 3. Apply cert-manager-issuer.yaml
# 4. Update DNS to point to LoadBalancer IP
# 5. Change "weather-agent.com" to your actual domain
# 6. Start with letsencrypt-staging, then switch to letsencrypt-prod

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: weather-agent-ingress
  namespace: default
  annotations:
    # ========================================
    # INGRESS CONTROLLER
    # ========================================
    kubernetes.io/ingress.class: "nginx"

    # ========================================
    # SSL/TLS CONFIGURATION
    # ========================================
    # cert-manager will automatically request and manage SSL certificates
    # IMPORTANT: Start with "letsencrypt-staging" to test, then switch to "letsencrypt-prod"
    cert-manager.io/cluster-issuer: "letsencrypt-staging" # Change to "letsencrypt-prod" after testing!

    # Force HTTPS redirect (HTTP â†’ HTTPS)
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # ========================================
    # SECURITY HEADERS
    # ========================================
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";

    # ========================================
    # CORS CONFIGURATION
    # ========================================
    # Enable CORS for API access from frontend
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://weather-agent.com,https://www.weather-agent.com"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"

    # ========================================
    # RATE LIMITING (DDoS Protection)
    # ========================================
    # Limit requests per second per IP
    nginx.ingress.kubernetes.io/limit-rps: "100"

    # Limit concurrent connections per IP
    nginx.ingress.kubernetes.io/limit-connections: "10"

    # ========================================
    # PROXY SETTINGS
    # ========================================
    # Max request body size (for file uploads, etc.)
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

    # Timeouts (in seconds)
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"

    # Buffer sizes for large headers
    nginx.ingress.kubernetes.io/proxy-buffer-size: "8k"

spec:
  # ========================================
  # TLS/SSL CONFIGURATION
  # ========================================
  tls:
    - hosts:
        - weather-agent.com # CHANGE to your domain!
        - www.weather-agent.com # CHANGE to your domain!
      secretName: weather-agent-tls # cert-manager will create this Secret automatically

  # ========================================
  # ROUTING RULES
  # ========================================
  rules:
    # ----------------------------------------
    # Main domain: weather-agent.com
    # ----------------------------------------
    - host: weather-agent.com # CHANGE to your domain!
      http:
        paths:
          # Backend API routes
          # All requests to /api/* are routed to backend service
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 5001

          # Metrics endpoint (optional, consider restricting access)
          # - path: /metrics
          #   pathType: Prefix
          #   backend:
          #     service:
          #       name: backend
          #       port:
          #         number: 5001

          # Frontend/Web routes
          # All other requests go to web service
          - path: /
            pathType: Prefix
            backend:
              service:
                name: web
                port:
                  number: 80 # Update if your web service uses a different port

    # ----------------------------------------
    # www subdomain: www.weather-agent.com
    # ----------------------------------------
    - host: www.weather-agent.com # CHANGE to your domain!
      http:
        paths:
          # Serve frontend on www subdomain
          - path: /
            pathType: Prefix
            backend:
              service:
                name: web
                port:
                  number: 80

---
# ALTERNATIVE: Separate subdomains for API and App
# Uncomment and use this if you want api.yourapp.com and app.yourapp.com

# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: weather-agent-ingress
#   namespace: default
#   annotations:
#     kubernetes.io/ingress.class: "nginx"
#     cert-manager.io/cluster-issuer: "letsencrypt-staging"  # Change to prod after testing
#     nginx.ingress.kubernetes.io/ssl-redirect: "true"
#     nginx.ingress.kubernetes.io/configuration-snippet: |
#       more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload";
#
# spec:
#   tls:
#     - hosts:
#         - api.weather-agent.com
#         - app.weather-agent.com
#         - weather-agent.com
#       secretName: weather-agent-tls
#
#   rules:
#     # API subdomain
#     - host: api.weather-agent.com
#       http:
#         paths:
#           - path: /
#             pathType: Prefix
#             backend:
#               service:
#                 name: backend
#                 port:
#                   number: 5001
#
#     # App subdomain
#     - host: app.weather-agent.com
#       http:
#         paths:
#           - path: /
#             pathType: Prefix
#             backend:
#               service:
#                 name: web
#                 port:
#                   number: 80
#
#     # Root domain (redirect to app)
#     - host: weather-agent.com
#       http:
#         paths:
#           - path: /
#             pathType: Prefix
#             backend:
#               service:
#                 name: web
#                 port:
#                   number: 80

---
# DEPLOYMENT STEPS:
#
# 1. Update domain names in this file (search for "CHANGE to your domain!")
#
# 2. Ensure your DNS is configured:
#    - A record: weather-agent.com â†’ <LoadBalancer-IP>
#    - A record: www.weather-agent.com â†’ <LoadBalancer-IP>
#
# 3. Deploy with staging issuer first:
#    kubectl apply -f k8s/ingress-production.yaml
#
# 4. Watch certificate creation:
#    kubectl get certificate --watch
#
# 5. Test that staging certificate works:
#    curl -k https://weather-agent.com  # -k ignores untrusted cert
#
# 6. Switch to production issuer:
#    - Edit annotation: cert-manager.io/cluster-issuer: "letsencrypt-prod"
#    - Delete old cert: kubectl delete secret weather-agent-tls
#    - Reapply: kubectl apply -f k8s/ingress-production.yaml
#
# 7. Verify production certificate:
#    curl https://weather-agent.com  # Should work without -k
#    # Or visit in browser - should show ðŸ”’ green padlock
#
# TROUBLESHOOTING:
# - Certificate not ready: kubectl describe certificate weather-agent-tls
# - Check cert-manager logs: kubectl logs -n cert-manager -l app=cert-manager
# - Check ingress logs: kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
